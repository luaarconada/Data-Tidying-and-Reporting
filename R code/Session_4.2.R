
## ----------------------------------------------------------------------------------------------
library(tidyverse)
library(forcats)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat %>%
  count(race)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
ggplot(gss_cat, aes(race)) +
  geom_bar()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
ggplot(gss_cat, aes(race)) +
  geom_bar() +
  scale_x_discrete(drop = FALSE)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
relig <- gss_cat %>%
  group_by(relig) %>%
  summarize(
    age = mean(age, na.rm = TRUE),
    tvhours = mean(tvhours, na.rm = TRUE),
    n = n()
  )
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
ggplot(relig, aes(tvhours, relig)) +
  geom_point()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
# fct_reorder is a relevel alternative
ggplot(relig, aes(tvhours, fct_reorder(relig, tvhours))) +
  geom_point()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
relig %>%
  mutate(relig = fct_reorder(relig, tvhours)) %>%
  ggplot(aes(tvhours, relig)) +
  geom_point()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
rincometable <- gss_cat %>%
  group_by(rincome) %>%
  summarize(
    age = mean(age, na.rm = TRUE),
    tvhours = mean(tvhours, na.rm = TRUE),
    n = n()
  )
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
ggplot(rincometable, aes(age, rincome)) +
  geom_point()

ggplot(rincometable, aes(age, fct_relevel(rincome, "Not applicable"))) +
  geom_point()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat %>%
  ggplot(aes(marital)) +
  geom_bar()

gss_cat %>%
  mutate(marital = marital %>%
           fct_infreq() %>%
           fct_rev()) %>%
  ggplot(aes(marital)) +
  geom_bar()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat %>% count(partyid)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat %>%
  mutate(partyid = fct_recode(partyid,
                              "Republican, strong" = "Strong republican",
                              "Republican, weak" = "Not str republican",
                              "Independent, near rep" = "Ind,near rep",
                              "Independent, near dem" = "Ind,near dem",
                              "Democrat, weak" = "Not str democrat",
                              "Democrat, strong" = "Strong democrat"
  )) %>%
  count(partyid)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat %>%
  mutate(partyid = fct_recode(partyid,
                              "Republican, strong" = "Strong republican",
                              "Republican, weak" = "Not str republican",
                              "Independent, near rep" = "Ind,near rep",
                              "Independent, near dem" = "Ind,near dem",
                              "Democrat, weak" = "Not str democrat",
                              "Democrat, strong" = "Strong democrat",
                              "Other" = "No answer",
                              "Other" = "Don't know",
                              "Other" = "Other party"
  )) %>%
  count(partyid)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat %>%
  mutate(partyid = fct_collapse(partyid,
                                other = c("No answer", "Don't know", "Other party"),
                                rep = c("Strong republican", "Not str republican"),
                                ind = c("Ind,near rep", "Independent", "Ind,near dem"),
                                dem = c("Not str democrat", "Strong democrat")
  )) %>%
  count(partyid)

# Exercise: create the matches above using regular expressions from stringr
recoded_levs <- map(.x = c("rep"= "repu", "dem" = "demo", "ind" = "Ind",
                           "other" = "answer|know|Other"),
                    .f = str_subset, string = levels(gss_cat$partyid))
gss_cat %>%
  mutate(partyid = fct_collapse(partyid,
                                other = recoded_levs$other,
                                rep = recoded_levs$rep,
                                ind = recoded_levs$ind,
                                dem = recoded_levs$dem
  )) %>%
  count(partyid)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat %>%
  mutate(relig = fct_lump(relig)) %>%
  count(relig)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
gss_cat %>%
  mutate(relig = fct_lump(relig, n = 10)) %>%
  count(relig, sort = TRUE)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
library(tidyverse)
library(lubridate)
library(nycflights13)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
today()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
now()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
ymd("2017-01-31")
mdy("January 31st, 2017")
dmy("31-Jan-2017")

ymd("01-31-2017")
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
ymd(20170131)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
ymd_hms("2017-01-31 20:11:59")
mdy_hm("01/31/2017 08:01")
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights %>%
  select(year, month, day, hour, minute)

flights %>%
  select(year, month, day, hour, minute) %>%
  mutate(
    departure = make_datetime(year = year, month = month, day = day,
                              hour = hour, min = minute)
  )
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
make_datetime_100 <- function(year, month, day, time) {
  make_datetime(year, month, day, time %/% 100, time %% 100)
}

flights_dt <- flights %>%
  filter(!is.na(dep_time), !is.na(arr_time)) %>%
  mutate(
    dep_time = make_datetime_100(year, month, day, dep_time),
    arr_time = make_datetime_100(year, month, day, arr_time),
    sched_dep_time = make_datetime_100(year, month, day, sched_dep_time),
    sched_arr_time = make_datetime_100(year, month, day, sched_arr_time)
  ) %>%
  select(origin, dest, ends_with("delay"), ends_with("time"))
flights_dt
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights_dt %>%
  ggplot(aes(dep_time)) +
  geom_freqpoly(binwidth = 86400) # 86400 seconds = 1 day
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights_dt %>%
  filter(dep_time < ymd(20130102)) %>%
  ggplot(aes(dep_time)) +
  geom_freqpoly(binwidth = 600) # 600 s = 10 minutes
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
datetime <- ymd_hms("2016-07-08 12:34:56")
year(datetime)

month(datetime)

mday(datetime)

yday(datetime)

wday(datetime, week_start = 1) # So week starts on Monday
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights_dt %>%
  mutate(wday = wday(dep_time, label = TRUE, locale = "English_United States")) %>%
  ggplot(aes(x = wday)) +
  geom_bar()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights_dt %>%
  mutate(wday = wday(dep_time, label = TRUE)) %>%
  ggplot(aes(x = wday)) +
  geom_bar()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights_dt %>%
  mutate(minute = minute(dep_time)) %>%
  group_by(minute) %>%
  summarize(avg_delay = mean(arr_delay, na.rm = TRUE), n = n()) %>%
  ggplot(aes(minute, avg_delay)) +
  geom_line()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
sched_dep <- flights_dt %>%
  mutate(minute = minute(sched_dep_time)) %>%
  group_by(minute) %>%
  summarize(avg_delay = mean(arr_delay, na.rm = TRUE), n = n())

ggplot(sched_dep, aes(minute, avg_delay)) +
  geom_line()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
ggplot(sched_dep, aes(minute, n)) +
  geom_line()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights_dt %>%
  count(week = floor_date(dep_time, "week")) %>%
  ggplot(aes(week, n)) +
  geom_line()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights_dt %>%
  count(week = floor_date(dep_time, "week")) %>%
  ggplot(aes(week, n)) +
  geom_line()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
(datetime <- ymd_hms("2016-07-08 12:34:56"))
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
update(datetime, year = 2020, month = 2, mday = 2, hour = 2)
update(datetime, year = 2022)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
flights_dt %>%
  mutate(dep_hour = update(dep_time, yday = 1)) %>%
  ggplot(aes(dep_hour)) +
  geom_freqpoly(binwidth = 300)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
# How old is Manolo?
manolo_age <- today() - ymd(19791014)
manolo_age
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
as.duration(manolo_age)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
dseconds(15)
dminutes(10)
dhours(c(12, 24))
ddays(0:5)
dweeks(3)
dyears(1)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
2 * dyears(1)

dyears(1) + dweeks(12) + dhours(15)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
tomorrow <- today() + ddays(1)
tomorrow
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
last_year <- today() - dyears(1)
last_year
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
one_pm <- ymd_hms("2022-04-13 13:00:00")
one_pm

one_pm + days(1)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
seconds(15)

minutes(10)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
hours(c(12, 24))

days(7)

months(1:6)

weeks(3)

years(1)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
10 * (months(6) + days(1))

days(50) + 3 * hours(25) + minutes(2)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
# A leap year
ymd("2016-01-01") + dyears(1)

ymd("2016-01-01") + years(1)

one_pm + days(1)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
library(hms)

# order: seconds, minutes, hours
hms(seconds = 56, minutes = 34, hours = 12)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
hms(56, 34, 12) %>% class()
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
hours <- 1:3
data.frame(hours, hms = hms(hours = hours))
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
as_hms(1)
as_hms("12:34:56")
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
round_hms(as_hms("12:34:56"), sec = 5)
## ----------------------------------------------------------------------------------------------

## ----------------------------------------------------------------------------------------------
round_hms(as_hms("12:34:56"), sec = 60)
## ----------------------------------------------------------------------------------------------
